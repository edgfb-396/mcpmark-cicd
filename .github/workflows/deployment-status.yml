name: Deployment Status Workflow

on:
  push:
    branches:
      - main

jobs:
  pre-deployment:
    name: pre-deployment
    runs-on: ubuntu-latest
    outputs:
      issue_number: ${{ steps.create_issue.outputs.issue_number }}
      previous_sha: ${{ steps.commit_info.outputs.previous_sha }}
      current_sha: ${{ steps.commit_info.outputs.current_sha }}
      package_version: ${{ steps.commit_info.outputs.package_version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linting
        run: npm run lint

      - name: Run tests
        run: npm run test

      - name: Get commit information
        id: commit_info
        run: |
          CURRENT_SHA=$(git rev-parse HEAD)
          PREVIOUS_SHA=$(git rev-parse HEAD~1)
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          
          echo "current_sha=$CURRENT_SHA" >> $GITHUB_OUTPUT
          echo "previous_sha=$PREVIOUS_SHA" >> $GITHUB_OUTPUT
          echo "package_version=$PACKAGE_VERSION" >> $GITHUB_OUTPUT
          
          echo "Current SHA: $CURRENT_SHA"
          echo "Previous SHA: $PREVIOUS_SHA"
          echo "Package Version: $PACKAGE_VERSION"

      - name: Create deployment tracking issue
        id: create_issue
        uses: actions/github-script@v7
        with:
          script: |
            const currentSha = '${{ steps.commit_info.outputs.current_sha }}';
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Deployment Tracking - ${currentSha}`,
              body: `## Deployment Tracking Issue
              
              This issue tracks the deployment process for commit: \`${currentSha}\`
              
              ### Deployment Information
              - **Commit**: ${currentSha}
              - **Triggered by**: ${context.payload.pusher.name}
              - **Workflow Run**: [View Run](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
              
              ### Status
              - [ ] Pre-deployment checks
              - [ ] Rollback preparation
              - [ ] Post-deployment verification`,
              labels: ['deployment', 'in-progress']
            });
            
            core.setOutput('issue_number', issue.data.number);
            return issue.data.number;

      - name: Comment on issue - Pre-deployment checks completed
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ steps.create_issue.outputs.issue_number }};
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `## Pre-deployment checks completed âœ…
              
              All quality checks have passed successfully.
              
              - âœ… Linting completed
              - âœ… Tests passed
              - âœ… Dependencies installed
              
              Proceeding to rollback preparation phase...`
            });

  rollback-preparation:
    name: rollback-preparation
    runs-on: ubuntu-latest
    needs: pre-deployment
    outputs:
      artifact_name: ${{ steps.artifact_info.outputs.artifact_name }}
      checksum: ${{ steps.artifact_info.outputs.checksum }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Create rollback artifacts directory
        run: mkdir -p rollback-artifacts

      - name: Create executable rollback script
        run: |
          cat > rollback-artifacts/rollback.sh << 'EOF'
          #!/bin/bash
          set -e

          echo "ðŸ”„ Starting rollback process..."

          # Configuration
          PREVIOUS_SHA="${1:-${PREVIOUS_SHA}}"
          CURRENT_SHA="${2:-${CURRENT_SHA}}"
          
          if [ -z "$PREVIOUS_SHA" ]; then
            echo "âŒ Error: Previous commit SHA not provided"
            exit 1
          fi

          echo "ðŸ“‹ Rollback Details:"
          echo "   From: $CURRENT_SHA"
          echo "   To:   $PREVIOUS_SHA"

          # Verify git repository
          if [ ! -d ".git" ]; then
            echo "âŒ Error: Not a git repository"
            exit 1
          fi

          # Check if commit exists
          if ! git rev-parse --verify "$PREVIOUS_SHA" >/dev/null 2>&1; then
            echo "âŒ Error: Previous commit $PREVIOUS_SHA not found"
            exit 1
          fi

          # Create backup of current state
          echo "ðŸ’¾ Creating backup of current state..."
          BACKUP_DIR="rollback-backup-$(date +%Y%m%d-%H%M%S)"
          mkdir -p "$BACKUP_DIR"
          cp -r package.json package-lock.json src tests "$BACKUP_DIR/" 2>/dev/null || true

          # Perform rollback
          echo "â®ï¸  Rolling back to $PREVIOUS_SHA..."
          git checkout "$PREVIOUS_SHA"

          # Verify rollback
          echo "ðŸ” Verifying rollback..."
          if [ "$(git rev-parse HEAD)" = "$PREVIOUS_SHA" ]; then
            echo "âœ… Rollback successful!"
            echo "ðŸ“ Now at commit: $PREVIOUS_SHA"
          else
            echo "âŒ Rollback failed!"
            exit 1
          fi

          # Install dependencies for the rolled-back version
          echo "ðŸ“¦ Installing dependencies for rolled-back version..."
          if [ -f "package.json" ]; then
            npm install
            echo "âœ… Dependencies installed"
          fi

          echo "ðŸŽ‰ Rollback process completed successfully!"
          echo ""
          echo "ðŸ“Œ Next steps:"
          echo "   1. Verify application functionality"
          echo "   2. Run tests: npm test"
          echo "   3. Start application: npm start"
          echo ""
          echo "ðŸ—‘ï¸  To return to latest commit: git checkout main"

          exit 0
          EOF

          chmod +x rollback-artifacts/rollback.sh

      - name: Backup configuration files
        run: |
          cp package.json rollback-artifacts/package.json.backup
          cp package-lock.json rollback-artifacts/package-lock.json.backup

      - name: Create environment template
        run: |
          cat > rollback-artifacts/.env.template << 'EOF'
          # Environment Configuration Template
          # Copy this file to .env and fill in your values

          # Application
          NODE_ENV=production
          PORT=3000

          # Database (if applicable)
          # DB_HOST=localhost
          # DB_PORT=5432
          # DB_NAME=your_database
          # DB_USER=your_username
          # DB_PASS=your_password

          # External Services (if applicable)
          # API_KEY=your_api_key
          # WEBHOOK_URL=your_webhook_url

          # Logging
          LOG_LEVEL=info
          EOF

      - name: Create dependency verification script
        run: |
          cat > rollback-artifacts/verify-dependencies.js << 'EOF'
          const fs = require('fs');
          const { execSync } = require('child_process');

          console.log('ðŸ” Verifying dependencies...');

          try {
            // Read package.json
            const packageJson = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            const dependencies = { ...packageJson.dependencies, ...packageJson.devDependencies };

            console.log(`Found ${Object.keys(dependencies).length} dependencies`);

            // Check if node_modules exists
            if (!fs.existsSync('node_modules')) {
              console.log('âš ï¸  node_modules not found. Running npm install...');
              execSync('npm install', { stdio: 'inherit' });
            }

            // Verify each dependency
            let missing = [];
            for (const [pkg, version] of Object.entries(dependencies)) {
              try {
                require.resolve(pkg);
                console.log(`âœ… ${pkg}@${version}`);
              } catch (e) {
                console.log(`âŒ ${pkg}@${version} - MISSING`);
                missing.push(pkg);
              }
            }

            if (missing.length > 0) {
              console.error(`\nâŒ ${missing.length} missing dependencies found:`);
              missing.forEach(pkg => console.error(`   - ${pkg}`));
              process.exit(1);
            }

            console.log('\nâœ… All dependencies verified successfully!');
          } catch (error) {
            console.error('âŒ Error verifying dependencies:', error.message);
            process.exit(1);
          }
          EOF

      - name: Create rollback documentation
        run: |
          cat > rollback-artifacts/ROLLBACK.md << 'EOF'
          # Rollback Documentation

          ## Overview
          This document provides step-by-step instructions for rolling back a deployment.

          ## Quick Rollback
          ```bash
          ./rollback.sh <previous-commit-sha> <current-commit-sha>
          ```

          ## Manual Rollback Steps

          ### 1. Verify Current State
          ```bash
          git status
          git log --oneline -5
          ```

          ### 2. Identify Target Commit
          Find the commit SHA you want to rollback to:
          ```bash
          git log --oneline
          ```

          ### 3. Perform Rollback
          ```bash
          git checkout <previous-commit-sha>
          ```

          ### 4. Install Dependencies
          ```bash
          npm install
          ```

          ### 5. Verify Installation
          ```bash
          node verify-dependencies.js
          npm test
          ```

          ### 6. Restart Application
          ```bash
          npm start
          ```

          ## Rollback Verification Checklist

          - [ ] Application starts without errors
          - [ ] All tests pass (`npm test`)
          - [ ] Dependencies are correctly installed
          - [ ] Configuration files are valid
          - [ ] Health check endpoint responds correctly
          - [ ] Logs show no critical errors

          ## Troubleshooting

          ### If rollback fails:
          1. Check git status: `git status`
          2. Stash changes if needed: `git stash`
          3. Retry rollback command

          ### If dependencies fail:
          1. Clear node_modules: `rm -rf node_modules`
          2. Clear npm cache: `npm cache clean --force`
          3. Reinstall: `npm install`

          ### If application fails to start:
          1. Check logs for specific errors
          2. Verify environment variables
          3. Check port availability
          4. Review configuration files

          ## Emergency Contacts
          - Primary: Development Team
          - Secondary: DevOps Team

          ## Additional Resources
          - Application logs: Check logging system
          - Monitoring: Check monitoring dashboard
          - Alerts: Review alert configuration
          EOF

      - name: Create compressed rollback package
        id: artifact_info
        run: |
          ARTIFACT_NAME="rollback-package-${{ needs.pre-deployment.outputs.current_sha }}"
          tar -czf "${ARTIFACT_NAME}.tar.gz" -C rollback-artifacts .
          
          # Generate SHA256 checksum
          CHECKSUM=$(sha256sum "${ARTIFACT_NAME}.tar.gz" | awk '{print $1}')
          echo "$CHECKSUM" > "${ARTIFACT_NAME}.sha256"
          
          echo "artifact_name=${ARTIFACT_NAME}" >> $GITHUB_OUTPUT
          echo "checksum=${CHECKSUM}" >> $GITHUB_OUTPUT
          
          echo "Artifact created: ${ARTIFACT_NAME}.tar.gz"
          echo "SHA256: ${CHECKSUM}"

      - name: Upload rollback artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.artifact_info.outputs.artifact_name }}
          path: |
            ${{ steps.artifact_info.outputs.artifact_name }}.tar.gz
            ${{ steps.artifact_info.outputs.artifact_name }}.sha256
          retention-days: 30

      - name: Comment on issue - Rollback Plan Ready
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ needs.pre-deployment.outputs.issue_number }};
            const previousSha = '${{ needs.pre-deployment.outputs.previous_sha }}';
            const currentSha = '${{ needs.pre-deployment.outputs.current_sha }}';
            const packageVersion = '${{ needs.pre-deployment.outputs.package_version }}';
            const artifactName = '${{ steps.artifact_info.outputs.artifact_name }}';
            const checksum = '${{ steps.artifact_info.outputs.checksum }}';
            
            const commentBody = `## ðŸ”„ Rollback Plan Ready
            
            All rollback artifacts have been prepared and verified.
            
            ### Deployment Information
            - âœ… Previous Commit: ${previousSha}
            - âœ… Current Commit: ${currentSha}
            - âœ… Package Version: ${packageVersion}
            - âœ… Artifact: ${artifactName}
            
            ### Rollback Components Created
            - âœ… Executable rollback script with error handling
            - âœ… Configuration backups (package.json, package-lock.json)
            - âœ… Environment template for configuration management
            - âœ… Dependency verification script for compatibility checking
            - âœ… Comprehensive rollback documentation with step-by-step instructions
            - âœ… Compressed rollback package with SHA256 checksums
            
            ### Quick Rollback Command
            \`\`\`bash
            # Download and extract the rollback package
            tar -xzf ${artifactName}.tar.gz
            
            # Run the rollback script
            ./rollback.sh ${previousSha} ${currentSha}
            \`\`\`
            
            ### Verification Status
            - Rollback script created: true
            - Configuration backup: true
            - Dependency verification: true
            - Documentation generated: true
            - Artifact package created: true
            - SHA256: ${checksum}
            
            ### Next Steps
            The deployment will proceed automatically. If issues occur, use the rollback artifacts above.
            
            **Artifact Retention**: 30 days`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: commentBody
            });

  post-deployment:
    name: post-deployment
    runs-on: ubuntu-latest
    needs: [pre-deployment, rollback-preparation]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Remove in-progress label and add completed label
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ needs.pre-deployment.outputs.issue_number }};
            
            // Remove in-progress label
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                name: 'in-progress'
              });
            } catch (error) {
              console.log('Label in-progress may not exist');
            }
            
            // Add completed label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: ['completed']
            });

      - name: Comment on issue - Deployment Completed Successfully
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ needs.pre-deployment.outputs.issue_number }};
            const currentSha = '${{ needs.pre-deployment.outputs.current_sha }}';
            const artifactName = '${{ needs.rollback-preparation.outputs.artifact_name }}';
            const checksum = '${{ needs.rollback-preparation.outputs.checksum }}';
            
            const commentBody = `## Deployment Completed Successfully ðŸŽ‰
            
            The deployment has been completed successfully!
            
            ### Deployment Summary
            - **Commit**: ${currentSha}
            - **Status**: âœ… Successful
            - **Completed**: ${new Date().toISOString()}
            
            ### Rollback Artifact Details
            In case you need to rollback, the following artifacts are available:
            
            - **Artifact Name**: ${artifactName}
            - **SHA256 Checksum**: ${checksum}
            - **Retention**: 30 days
            - **Download**: Available in GitHub Actions artifacts
            
            ### Rollback Instructions
            If you need to rollback this deployment:
            
            1. Download the artifact from GitHub Actions
            2. Extract: \`tar -xzf ${artifactName}.tar.gz\`
            3. Run: \`./rollback.sh <previous-sha> ${currentSha}\`
            
            ### Verification
            Please verify the deployment:
            - [ ] Application is running
            - [ ] Health checks pass
            - [ ] No critical errors in logs
            - [ ] Monitoring shows normal metrics
            
            ---
            *This deployment tracking issue will now be closed.*`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: commentBody
            });

      - name: Close deployment tracking issue
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ needs.pre-deployment.outputs.issue_number }};
            
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              state: 'closed',
              state_reason: 'completed'
            });